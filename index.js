var data = newFunction()





function newFunction() {
    return [
        {
            id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
            name: "深圳市泊寓租赁服务有限公司",
            projects: [
                {
                    project_id: "39e8b034-f745-a763-2979-efdf9c710b78",
                    project_company_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                    project_name: "骏哥哥内部划拨测试0726",
                    project_source: "泊寓拓展",
                    is_project_expand: "1",
                    is_old_back: false,projects: [
                        {
                            project_id: "39e8b034-f745-a763-2979-efdf9c710b78",
                            project_company_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                            project_name: "骏哥哥内部划拨测试0726",
                            project_source: "泊寓拓展",
                            is_project_expand: "1",
                            is_old_back: false
                        },
                        {
                            project_id: "39e7e43a-f174-3ee0-d1ea-73b2cb2aebc5",
                            project_company_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                            project_name: "123",
                            project_source: "泊寓拓展",
                            is_project_expand: "0",
                            is_old_back: false
                        },
                        {
                            project_id: "39eae22c-535c-f2dc-d211-10b1bfef9d81",
                            project_company_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                            project_name: "249892365@qq.com",
                            project_source: "泊寓拓展",
                            is_project_expand: "1",
                            is_old_back: false
                        },
                        {
                            project_id: "39eabe47-7942-45aa-b28b-274d9ec474ce",
                            project_company_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                            project_name: "第三方",
                            project_source: "泊寓拓展",
                            is_project_expand: "0",
                            is_old_back: false
                        }
                    ]
                },
                {
                    project_id: "39e7e43a-f174-3ee0-d1ea-73b2cb2aebc5",
                    project_company_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                    project_name: "123",
                    project_source: "泊寓拓展",
                    is_project_expand: "0",
                    is_old_back: false
                },
                {
                    project_id: "39eae22c-535c-f2dc-d211-10b1bfef9d81",
                    project_company_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                    project_name: "249892365@qq.com",
                    project_source: "泊寓拓展",
                    is_project_expand: "1",
                    is_old_back: false
                },
                {
                    project_id: "39eabe47-7942-45aa-b28b-274d9ec474ce",
                    project_company_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                    project_name: "第三方",
                    project_source: "泊寓拓展",
                    is_project_expand: "0",
                    is_old_back: false
                },
                {
                    project_id: "39e7e3e6-5013-44b8-d9ae-da8f47377f98",
                    project_company_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                    project_name: "kgsadjh",
                    project_source: "泊寓拓展",
                    is_project_expand: "0",
                    is_old_back: false
                },
                {
                    project_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                    project_name: "深圳市泊寓租赁服务有限公司后台部门",
                    project_company_id: "39e41552-2b63-c709-e3b7-55d394d47ba1",
                    is_old_back: true,
                    is_project_expand: "0"
                }
            ]
        },
        {
            id: "39ea60da-72a8-269a-f2f8-3e71ef6bb3e4",
            name: "深圳市万村发展有限公司",
            projects: [
                {
                    project_id: "39ea5216-13ab-3530-5ec0-ad03ba3edd08",
                    project_company_id: "39ea60da-72a8-269a-f2f8-3e71ef6bb3e4",
                    project_name: "duan内部划拨11230002",
                    project_source: "泊寓拓展",
                    is_project_expand: "1",
                    is_old_back: false
                },
                {
                    project_id: "39ea4721-4b47-a9c0-2c5b-6e47cf56f5a8",
                    project_name: "测试",
                    project_company_id: "39ea60da-72a8-269a-f2f8-3e71ef6bb3e4",
                    is_old_back: false,
                    is_project_expand: "0"
                },
                {
                    project_id: "39ea4721-e07b-4348-bd99-e80dc2ba20e8",
                    project_name: "111",
                    project_company_id: "39ea60da-72a8-269a-f2f8-3e71ef6bb3e4",
                    is_old_back: false,
                    is_project_expand: "0"
                },
                {
                    project_id: "39ea60da-72a8-269a-f2f8-3e71ef6bb3e4",
                    project_name: "深圳市万村发展有限公司后台部门",
                    project_company_id: "39ea60da-72a8-269a-f2f8-3e71ef6bb3e4",
                    is_old_back: true,
                    is_project_expand: "0"
                }
            ]
        },
        {
            id: "39ea6621-32ec-ea04-0a8c-826fa57c1fff",
            name: "小泊厉害111",
            projects: [
                {
                    project_id: "39e7e2f9-839f-4843-bfa6-ea4082cfdd14",
                    project_company_id: "39ea6621-32ec-ea04-0a8c-826fa57c1fff",
                    project_name: "小岚岚",
                    project_source: "泊寓拓展",
                    is_project_expand: "1",
                    is_old_back: false
                },
                {
                    project_id: "39ea50a2-53f2-d4a1-3ce8-5a07360f3272",
                    project_company_id: "39ea6621-32ec-ea04-0a8c-826fa57c1fff",
                    project_name: "沃土01(万村)",
                    project_source: "万村拓展",
                    is_project_expand: "1",
                    is_old_back: false
                },
                {
                    project_id: "39ea50a2-53ff-c0e6-630c-2cd5d3d3ff91",
                    project_company_id: "39ea6621-32ec-ea04-0a8c-826fa57c1fff",
                    project_name: "jsj(万村)",
                    project_source: "万村拓展",
                    is_project_expand: "1",
                    is_old_back: false
                },
                {
                    project_id: "39ea6621-32ec-ea04-0a8c-826fa57c1fff",
                    project_name: "小泊厉害111后台部门",
                    project_company_id: "39ea6621-32ec-ea04-0a8c-826fa57c1fff",
                    is_old_back: true,
                    is_project_expand: "0"
                }
            ]
        },
        {
            id: "39ea6f6f-bb46-a553-8cfc-bf2ea7e9b9ed",
            name: "11111",
            projects: [
                {
                    project_id: "39ea6f6f-bb46-a553-8cfc-bf2ea7e9b9ed",
                    project_name: "11111后台部门",
                    project_company_id: "39ea6f6f-bb46-a553-8cfc-bf2ea7e9b9ed",
                    is_old_back: true,
                    is_project_expand: "0"
                }
            ]
        },
        {
            id: "39eab925-10e3-edeb-9f5c-b9da961f8afb",
            name: "南通小波肉纺织品有限公司",
            projects: [
                {
                    project_id: "39eab445-b9c9-ee4f-b837-516734da48b0",
                    project_company_id: "39eab925-10e3-edeb-9f5c-b9da961f8afb",
                    project_name: "周先生的项目001(万村)",
                    project_source: "万村拓展",
                    is_project_expand: "1",
                    is_old_back: false
                },
                {
                    project_id: "39e988b1-7be9-38dc-5670-0e53409350bc",
                    project_company_id: "39eab925-10e3-edeb-9f5c-b9da961f8afb",
                    project_name: "xh_1015_ 内部划拨",
                    project_source: "泊寓拓展",
                    is_project_expand: "1",
                    is_old_back: false
                },
                {
                    project_id: "39eab925-10e3-edeb-9f5c-b9da961f8afb",
                    project_name: "南通小波肉纺织品有限公司后台部门",
                    project_company_id: "39eab925-10e3-edeb-9f5c-b9da961f8afb",
                    is_old_back: true,
                    is_project_expand: "0"
                }
            ]
        },
        {
            id: "39ead229-e378-e7d4-6c6b-2a13427e80af",
            name: "广州万科置业有限公司",
            projects: [
                {
                    project_id: "39ead74a-a7d7-7bdb-3349-19a976f23fad",
                    project_company_id: "39ead229-e378-e7d4-6c6b-2a13427e80af",
                    project_name: "测试泊寓房东合同中止之后卡片状态同步更新用",
                    project_source: "泊寓拓展",
                    is_project_expand: "1",
                    is_old_back: false
                },
                {
                    project_id: "39ead226-2f7f-03aa-e4d5-0725998d5a17",
                    project_company_id: "39ead229-e378-e7d4-6c6b-2a13427e80af",
                    project_name: "泊寓房东合同确认交付生成资产卡片拉通测试用",
                    project_source: "泊寓拓展",
                    is_project_expand: "1",
                    is_old_back: false
                },
                {
                    project_id: "39ead334-537c-ba00-4150-cd0058b56db3",
                    project_company_id: "39ead229-e378-e7d4-6c6b-2a13427e80af",
                    project_name: "泊寓房东合同确认交付生成资产卡片拉通测试用01",
                    project_source: "泊寓拓展",
                    is_project_expand: "1",
                    is_old_back: false
                },
                {
                    project_id: "39eaecfc-649a-2ec3-ff61-5f3af2bc065b",
                    project_name: "华为技术有限公司",
                    project_company_id: "39ead229-e378-e7d4-6c6b-2a13427e80af",
                    is_old_back: false,
                    is_project_expand: "0"
                },
                {
                    project_id: "39ead229-e378-e7d4-6c6b-2a13427e80af",
                    project_name: "广州万科置业有限公司后台部门",
                    project_company_id: "39ead229-e378-e7d4-6c6b-2a13427e80af",
                    is_old_back: true,
                    is_project_expand: "0"
                }
            ]
        },
        {
            id: "39eb3924-9c4c-eff0-a22b-b213dbd8abea",
            name: "杭州娃哈哈进出口有限公司",
            projects: [
                {
                    project_id: "39eb3923-2066-aaec-5e8e-c52aaf8926ae",
                    project_name: "吖24242424",
                    project_company_id: "39eb3924-9c4c-eff0-a22b-b213dbd8abea",
                    is_old_back: false,
                    is_project_expand: "0"
                },
                {
                    project_id: "39eb3924-9c4c-eff0-a22b-b213dbd8abea",
                    project_name: "杭州娃哈哈进出口有限公司后台部门",
                    project_company_id: "39eb3924-9c4c-eff0-a22b-b213dbd8abea",
                    is_old_back: true,
                    is_project_expand: "0"
                }
            ]
        }
    ];
}






///////////////////////////////////////// new select2////////////////////////////////////
class TranslateTreeIntoList {
    constructor({
        data = {},
        childNameList = [],
        targetNameList = [],
    }){
        this.childNameList = childNameList;
        this.targetNameList = targetNameList;
        this.data = data;
        this.list = [];
        this.initData();
    }
    hasChildren(node){
        for (let i = 0; i < this.childNameList.length; i++) {
            if(node[this.childNameList[i]]){
                return node[this.childNameList[i]]
            }
        }
        return false;
    }
    
    getNodeName (node) {
        for (let i = 0; i < this.targetNameList.length; i++) {
            if(node[this.targetNameList[i]]){
                return node[this.targetNameList[i]]
            }
        }
        return false;
    }
    
    initData () {
        if(!this.data || this.data==[]) {
            return []
        } else if(this.data.length>0){
            this.data.forEach(node=>{
                this.findPath({node,path:this.getNodeName(node)});
            })
        }
    }
    // 找到底部，并且记录寻径步骤
    // 当目标节点没有子节点，认为已经找到了底，仅仅返回false，但是向大类，push一个
    findPath({node,path=''}){
        if (this.hasChildren(node)) {
            this.hasChildren(node).forEach(node=>{
                name = path + " > " + this.getNodeName(node);
                this.findPath({node,path:name});
            })
        } else {
            this.list.push(path);
        };
    }
    // 清洗数据
    clearData(data){
        var that = this;
        if(data.selectIndex){
            data.selectIndex = -1;
        }
        data.forEach(function(e) {
            if(that.hasChildren(e)){
                that.clearData(that.hasChildren(e));
            }
        })
    }
    // 基础方法，捕获节点
    catchDom({dom,className}) {
        if(dom == document.body){
            // 最多冒泡到body
            return false;
        }else if (dom.classList.contains(className)) {
            // 如果符合条件，返回这次冒泡捕获到的元素
            return dom;
        } else {
            // 尾递归其父元素
            return this.catchDom({dom:dom.parentElement,className});
        }
    };
}
  
// Select3 插件
function Select3({
    select,
    data = [],
    childNameList = [],
    targetNameList = [],
    level=[]
}) {
    this.select3Container = document.createElement('div');
    this.dropContainer = document.createElement('div');
    this.input = document.createElement('input');
    this.inputContainer = document.createElement('div');
    this.select = select;
    this.width = this.select.getBoundingClientRect().width;
    this.level = level;
    this.data = data;
    this.childNameList = [...childNameList,'child','children','projects'];
    this.targetNameList = [...targetNameList,'name','project_name'];
    this.list = (new TranslateTreeIntoList({...this})).list;           // 转换后的扁平化的二级数据
    this.init();
}

  Select3.prototype = new TranslateTreeIntoList({data:{}});
  
  Select3.prototype.init = function(){
    this.initElement();
    this.initCss();
    this.bindEvent();
  };
  Select3.prototype.initElement = function(){
    this.select.classList.add('hide');
    this.select3Container.className = 'select3-container';
    this.inputContainer.className = 'form-control input-container';
    this.inputContainer.appendChild(this.input);
    const btn = document.createElement('span');
    btn.innerHTML = "✖";
    btn.id = 'clear';
    btn.className = 'clear hide';
    this.inputContainer.appendChild(btn);
    this.dropContainer.className = 'drop-container';
    this.input.placeholder = '键入检索';
    this.select.parentElement.insertBefore(this.select3Container,this.select);
    this.select3Container.appendChild(this.inputContainer);
    this.select3Container.appendChild(this.dropContainer);
  }
  Select3.prototype.bindEvent = function(){
    // 键入事件监听
    this.input.addEventListener('keyup',(e) => {
        if(e.target.value.length>0){
            this.globalMatch(e.target.value);
            this.inputContainer.querySelector('.clear').classList.remove('hide');
        } else {
            this.selectMatch({currentClickLevel:-1});
            this.inputContainer.querySelector('.clear').classList.add('hide');
        }
    })
    // 点击清空按钮
    this.inputContainer.querySelector('#clear').addEventListener('click',(e) => {
        this.clearData(this.data);
        this.input.click();
        this.input.value = '';
        this.select.options[0] = new Option(this.input.value,this.input.value);
        this.input.focus();
        this.inputContainer.querySelector('.clear').classList.add('hide');
    })
    // 容器内的具体选项选择
    document.body.addEventListener('click',(e) => {
        var isDom = this.catchDom({dom:e.target,className:'list'})
        if (isDom) {
            if (isDom.parentElement.classList.contains('global-select-container')) {
                // 全局选择
                this.dropContainer.innerHTML = '';
                this.input.value = isDom.title;
                this.select.options[0] = new Option(this.input.value,this.input.value);
            } else if (isDom.parentElement.classList.contains('body')) {
                // 为root数据模型添加属性，表示当前选择的元素
                if(isDom.parentElement.querySelector('.active')){
                    isDom.parentElement.querySelector('.active').classList.remove('active');
                };
                isDom.classList.add('active');
                isDom.parentElement.parentElement.root.selectIndex = isDom.dataset.index;
                this.selectMatch({
                    // 当前点击的级别
                    currentClickLevel: isDom.parentElement.parentElement.dataset.level
                });
                this.input.value = this.enumerateAllList()
                this.select.options[0] = new Option(this.input.value,this.input.value);
                this.inputContainer.querySelector('.clear').classList.remove('hide');
                if(!this.hasChildren(isDom.parentElement.parentElement.root[isDom.dataset.index])){
                    this.dropContainer.innerHTML = '';
                }
            }
            return;
        }
        // 捕获select3-container节点
        isDom = this.catchDom({dom:e.target,className:'select3-container'})
        if(!isDom){
            this.dropContainer.innerHTML = '';
            return;
        };
        // 捕获 input-container 节点
        isDom = this.catchDom({dom:e.target,className:'input-container'})
        if(isDom){
            if(isDom.querySelector('input').value == ''){
                this.selectMatch({currentClickLevel:-1});
            }
            return;
        }
    })
}
  
Select3.prototype.enumerateAllList = function(){
    const listDom = this.dropContainer.querySelectorAll('.active');
    return Array.prototype.slice.call(listDom).map(e=>e.innerHTML).join(' > ');
}
  
Select3.prototype.initCss = function(){
    if(!document.querySelector('style.wdqwdwdwdw')){
        const style = document.createElement('style');
        style.className = 'wdqwdwdwdw';
        style.innerHTML = `
            .select3-container {
                position: relative;
            }
            .input-container {
                display: flex!important;
                flex-direction: row;
                align-items: center;
                margin-bottom: 10px;
            }
            .input-container input {
                outline: none;
                border: none;
                margin: 0;
                flex: 1 0 auto;
                font-size: 12px;
            }
            .input-container .clear {
                cursor: pointer;
                flex: 0 0 auto;
                user-select: none;
            }
            
            .drop-container {
                position: absolute;
                z-index: 10;
                top: 37px;
                left: 0px;
                padding: 0;
                width: auto;
                overflow: hidden;
                background: white;
                border: 1px solid #C2CAD8FF;
                border-radius: 5px;
                display: flex;
            }
            .global-select-container {
                padding: 0;
                width: ${this.width}px;
                height: 160px;
                overflow: auto;
                background: white;
            }
            .drop-container .empty {
                height: 100%;
                width: ${this.width}px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                font-size: 12px;
                color: rgba(102, 102, 102, 1);
            }
            .drop-container .empty img {
                width: 120px;
                margin: 12px;
            }
            .drop-container .list {
                color: rgba(102, 102, 102, 1);
                padding: 0 13px;
                height: 30px;
                line-height: 30px;
                cursor: pointer;
                width: 100%;
                font-size: 12px;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
            }
            .drop-container .list.active {
                background: rgba(53, 152, 220, 0.2);
            }
            .drop-container .list:hover {
                background: rgba(53, 152, 220, 0.2);
            }
            .drop-container .list .match {
                color: rgba(53, 152, 220, 1);
            }
            .drop-container .level-select-container {
                width: ${this.width/3}px;
                height: 160px;
            }
            .drop-container .level-select-container + .level-select-container {
                border-left: 1px solid #C2CAD8FF;
            }
  
            .drop-container .level-select-container .head {
                font-size: 14px;
                font-weight: bold;
                padding: 0 13px;
                line-height: 30px;
                height: 30px;
            }
            .drop-container .level-select-container .body {
                height: calc(100% - 30px);
                overflow: auto;
                font-size: 12px;
            }
        `;
        document.head.appendChild(style);
    }
}
  
// 全局匹配 ，当输入文字的时候触发
Select3.prototype.globalMatch = function(value){
    const filterList = this.list.filter(e=>e.match(value));
    if (filterList.length > 0) {
        const reg = new RegExp(`(${value})`);
        this.dropContainer.innerHTML = '<div class="global-select-container">'+filterList
            .map(e=> `
                <div class="list detail" title="${e}">
                    ${e.replace(reg,'<span class="match">$1</span>')}
                </div>
            `)
            .join('')+'</div>'
    } else if (filterList.length == 0) {
        this.dropContainer.innerHTML = `<div class="empty">
            <img src="https://static.pipk.top/api/public/images/8731889192064048.png"/>
            <p>无结果</p>
        </div>`
    }
}
// 3级匹配 ，当输入文字的时候触发
Select3.prototype.selectMatch = function({currentClickLevel}) {
    const generatContainer = ({data,head,level})=>{
        const container = document.createElement('div');
        container.className = 'level-select-container';
        container.root = data;
        container.dataset.level = level;
        container.innerHTML = `
            <div class="head">
                ${head}
            </div>
            <div class="body">
                ${data.map((e,i)=>`<div title="${this.getNodeName(e)}" data-index="${i}" class="list ${data.selectIndex==i?'active':''}">${this.getNodeName(e)}</div>`).join('')}
            </div>
        `;
        return container;
    };
    // 清除除了当前点击项目，之后的级别选择框
    Array.prototype.slice.call(this.dropContainer.children).forEach((e,i)=>i>currentClickLevel?e.remove():'')
    let i = 0;
    let level = 0;
    const recursion = ({data})=>{
        if(Number(currentClickLevel) < Number(level)){
            const appendContainer = generatContainer({data,head:this.level[i++],level:level++});
            this.dropContainer.append(appendContainer);
            appendContainer.querySelector('.active')&&appendContainer.querySelector('.active').scrollIntoView();
        }else{
            generatContainer({data,head:this.level[i++],level:level++});
        }
        // 如果有子元素，继续递归
        if(
            data.selectIndex > -1 &&
            this.hasChildren(data[data.selectIndex])
        ){
            recursion({data:this.hasChildren(data[data.selectIndex])});
        };
    };
    recursion({data:this.data})
}
  


new Select3({
    childNameList:[],                               // 可能的子元素键盘值
    targetNameList:[],                              // 当前节点储存原俗名
    select: document.querySelector(".select2"),     // 当前select元素
    level: ['事项分类','费用分类','费用名称'],        // 等级名称
    data,
})
















